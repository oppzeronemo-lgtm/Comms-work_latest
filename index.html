<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UDP Programme Comms Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.css" />
  <script src="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --pending: #FFD8A8;   /* Pending (0%) */
      --doing: #EDE8D0;     /* In progress base */
      --done: #008000;      /* Completed overlay */
      --done-base: #E8F5EA; /* Completed base */
    }
    body { margin:0; font-family: Inter, sans-serif; background:#fff; color:#202124; }
    .wrap { padding:16px; height:100vh; display:flex; flex-direction:column; }
    .topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .brand { font-weight:700; font-size:18px; }
    .card { flex:1; background:#fafafa; border:1px solid #eee; border-radius:12px; padding:12px; display:flex; flex-direction:column; }
    #gantt { flex:1; border:1px solid #eee; border-radius:8px; }
    .legend { margin-top:8px; font-size:13px; color:#555; display:flex; gap:18px; }
    .sw { width:12px; height:12px; display:inline-block; border-radius:3px; margin-right:4px; }
    .sw.pending { background: var(--pending); }
    .sw.doing { background: var(--doing); }
    .sw.done { background: var(--done); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">UDP Programme Comms Dashboard</div>
      <div>
        <select id="monthSelect"></select>
        <button id="viewDay">Day</button>
        <button id="viewWeek">Week</button>
        <button id="viewMonth">Month</button>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>
    <div class="card">
      <div id="gantt"></div>
      <div class="legend">
        <span><span class="sw pending"></span> Pending (0%)</span>
        <span><span class="sw doing"></span> In progress</span>
        <span><span class="sw done"></span> Completed (100%)</span>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://wjfgntocqjtwaqamlbgc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = { view:'Week', monthKey:keyFromDate(new Date()) };
    let gantt, tasksById = {};

    init();

    async function init(){
      buildMonthPicker();
      await render();
      bindControls();
      subscribeRealtime();
    }

    function bindControls(){
      monthSelect.onchange = ()=>{ state.monthKey = monthSelect.value; render(); };
      viewDay.onclick = ()=>setView('Day');
      viewWeek.onclick = ()=>setView('Week');
      viewMonth.onclick = ()=>setView('Month');
      refreshBtn.onclick = ()=>render();
      window.addEventListener('resize', ()=>{ if(gantt) gantt.refresh(); });
    }
    function setView(v){ state.view=v; if(gantt) gantt.change_view_mode(v); }

    function buildMonthPicker(){
      const base=new Date(); base.setDate(1); monthSelect.innerHTML='';
      for(let o=-2;o<=6;o++){
        const d=new Date(base); d.setMonth(d.getMonth()+o);
        const key=keyFromDate(d);
        const opt=document.createElement('option');
        opt.value=key; opt.textContent=d.toLocaleString(undefined,{month:'long',year:'numeric'});
        if(key===state.monthKey) opt.selected=true;
        monthSelect.appendChild(opt);
      }
    }
    function keyFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function monthRangeFromKey(key){ const [y,m]=key.split('-').map(Number); return { start:new Date(y,m-1,1), end:new Date(y,m,0,23,59,59,999) }; }

    async function fetchTasks(){
      const { data, error } = await supabase.from('tasks').select('*').order('start_date',{ascending:true});
      if(error){ console.error(error); return []; }
      const { start, end } = monthRangeFromKey(state.monthKey);
      return (data||[]).filter(t => new Date(t.end_date||t.start_date)>=start && new Date(t.start_date)<=end);
    }

    async function render(){
      const rows = await fetchTasks();
      const tasks = rows.map(r=>({
        id:r.id, name:r.title, start:toYMD(r.start_date), end:toYMD(r.end_date||r.start_date),
        progress:Number(r.progress||0), dependencies:(r.dependencies||'').trim(), notes:r.notes||''
      }));
      tasksById=Object.fromEntries(tasks.map(t=>[String(t.id),t]));
      document.getElementById('gantt').innerHTML='';
      gantt = new Gantt('#gantt', tasks, { view_mode:state.view, date_format:'YYYY-MM-DD' });
      colorizeBars();
    }

    function colorizeBars(){
      document.querySelectorAll('#gantt .bar-wrapper').forEach(w=>{
        const id=w.getAttribute('data-id'); const t=tasksById[id]; if(!t) return;
        const bar=w.querySelector('.bar'); const prog=w.querySelector('.bar-progress');
        if(!bar||!prog) return;
        const p=Math.max(0,Math.min(100,Number(t.progress||0)));
        if(p===0){ bar.setAttribute('fill',css('--pending')); prog.setAttribute('fill','rgba(0,0,0,0)'); }
        else if(p>=100){ bar.setAttribute('fill',css('--done-base')); prog.setAttribute('fill',css('--done')); }
        else { bar.setAttribute('fill',css('--doing')); prog.setAttribute('fill',beigeRamp(p)); }
      });
    }

    // Beige ramp (1â€“99%)
    function beigeRamp(p){
      const h=38, s=70; const lStart=90, lEnd=55;
      const l=lStart+(lEnd-lStart)*(p/100);
      return `hsl(${h},${s}%,${l}%)`;
    }

    function subscribeRealtime(){
      supabase.channel('public:tasks')
        .on('postgres_changes',{event:'*',schema:'public',table:'tasks'}, debounce(()=>{render();},300))
        .subscribe();
    }

    function toYMD(d){ const x=new Date(d); return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`; }
    function css(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
    function debounce(fn,wait){ let t; return(...a)=>{clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),wait);}; }
  </script>
</body>
</html>
