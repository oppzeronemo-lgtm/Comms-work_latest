<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UDP Programme Comms Dashboard</title>

  <!-- Frappe Gantt -->
  <link rel="stylesheet" href="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.css" />
  <script src="https://unpkg.com/frappe-gantt@0.6.1/dist/frappe-gantt.min.js"></script>

  <!-- Supabase (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      /* Status colours */
      --pending:#FFD8A8;   /* 0% (light orange) */
      --doing:#EDE8D0;     /* in-progress base (light ash/beige) */
      --done:#008000;      /* 100% overlay */
      --done-base:#E8F5EA; /* 100% base */
      --ink:#202124; --muted:#6b7280; --border:#e5e7eb; --card:#fafafa;
      --danger:#b42318; --danger-bg:#fee4e2;
    }

    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--ink);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}

    .wrap{height:100%;display:flex;flex-direction:column;padding:16px;box-sizing:border-box;gap:12px}
    .top{display:flex;justify-content:space-between;align-items:center}
    .brand{font-weight:700;font-size:18px}
    .controls>*{margin-left:6px}

    .card{flex:1;display:flex;flex-direction:column;min-height:0;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    #gantt{flex:1;border:1px solid var(--border);border-radius:12px;background:#fff;min-height:520px;overflow:hidden}

    /* Legend */
    .legend{display:flex;gap:18px;align-items:center;color:var(--muted);font-size:13px;margin-top:8px}
    .sw{width:12px;height:12px;border-radius:3px;margin-right:6px;display:inline-block;border:1px solid #d1d5db}
    .sw.pending{background:var(--pending)}
    .sw.doing{background:var(--doing)}
    .sw.done{background:var(--done)}

    /* Bars – thicker & flat */
    #gantt .bar, #gantt .bar-progress { height:28px; rx:6px; ry:6px; stroke:none !important }
    #gantt .bar-wrapper{ transform:translateY(12px) }
    .gantt .bar-label{ font-weight:700; fill:#111827; font-size:13.5px; stroke:none }

    /* Make SVG fill container (prevents inner slider) */
    #gantt svg{width:100% !important;height:auto;display:block}

    /* Tooltip */
    .tip{position:absolute;background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;
         box-shadow:0 10px 24px rgba(0,0,0,.10);font-size:13px;display:none;pointer-events:none;z-index:1000}

    /* Status banners */
    .banner{border:1px solid var(--border);background:#fff;border-radius:10px;padding:14px;margin:10px;color:#111}
    .banner.error{border-color:var(--danger); background:var(--danger-bg); color:var(--danger)}
    .spinner{display:flex;align-items:center;gap:10px;color:var(--muted);padding:10px}
    .spinner:before{content:'';width:16px;height:16px;border-radius:50%;border:3px solid #ddd;border-top-color:#999;display:inline-block;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">UDP Programme Comms Dashboard</div>
      <div class="controls">
        <select id="monthSelect" title="Pick month"></select>
        <button id="viewDay">Day</button>
        <button id="viewWeek">Week</button>
        <button id="viewMonth">Month</button>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="card">
      <div id="statusArea" class="spinner">Loading tasks…</div>
      <div id="gantt" aria-live="polite"></div>
      <div class="legend">
        <span><span class="sw pending"></span>Pending (0%)</span>
        <span><span class="sw doing"></span>In progress</span>
        <span><span class="sw done"></span>Completed (100%)</span>
      </div>
    </div>
  </div>

  <div id="tip" class="tip"></div>

  <script>
    // ── Supabase ────────────────────────────────────────────────────────────────
    const SUPABASE_URL = "https://wjfgntocqjtwaqamlbgc.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqZmdudG9jcWp0d2FxYW1sYmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjQzODIsImV4cCI6MjA3MDk0MDM4Mn0.IRwC5-0cv2rkaZbzR1Ovxnt6dl0m1IwJgcLl2I67YzQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ── App state ───────────────────────────────────────────────────────────────
    const state = { view:'Week', monthKey:keyFromDate(new Date()) };
    let gantt, tasksById = {}, allRows = [];
    let buildingPicker = false;
    let isLoading = false;

    // ── Boot ───────────────────────────────────────────────────────────────────
    init();
    async function init(){
      bindControls();
      showSpinner();
      await loadAllRows();
      buildMonthPickerFromData();
      await renderForMonth(state.monthKey);

      // Debounced resize (prevents re-render storms)
      window.addEventListener('resize', debounce(()=>{ renderForMonth(state.monthKey); }, 250));
    }

    // ── UI helpers ─────────────────────────────────────────────────────────────
    function showSpinner(msg='Loading tasks…'){
      const s = document.getElementById('statusArea');
      s.className = 'spinner';
      s.textContent = msg;
    }
    function showError(message, hint=''){
      const el = document.getElementById('statusArea');
      el.className = 'banner error';
      el.innerHTML = `<strong>Error:</strong> ${escapeHtml(message)}${hint?`<br><small>${escapeHtml(hint)}</small>`:''}`;
    }
    function clearStatus(){ const el=document.getElementById('statusArea'); el.className=''; el.innerHTML=''; }

    // ── Controls ───────────────────────────────────────────────────────────────
    function bindControls(){
      monthSelect.addEventListener('change', () => {
        if(buildingPicker) return;
        state.monthKey = monthSelect.value;
        renderForMonth(state.monthKey);
      });
      viewDay.onclick   = () => changeView('Day');
      viewWeek.onclick  = () => changeView('Week');
      viewMonth.onclick = () => changeView('Month');
      refreshBtn.onclick= async () => {
        if(isLoading) return;
        showSpinner('Refreshing…');
        await loadAllRows();
        buildMonthPickerFromData();
        await renderForMonth(state.monthKey);
      };
    }
    function changeView(v){ state.view=v; if(gantt){ gantt.change_view_mode(v); applyColors(); } }

    // ── Date utilities ─────────────────────────────────────────────────────────
    function keyFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function monthRangeFromKey(key){ const [y,m]=key.split('-').map(Number); return { start:new Date(y,m-1,1), end:new Date(y,m,0,23,59,59,999) }; }
    function toYMD(d){ const x=new Date(d); return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`; }
    function css(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
    function daysBetween(a,b){ return Math.max(1, Math.round((b - a) / 86400000)); }
    function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

    // ── Data loading ───────────────────────────────────────────────────────────
    async function loadAllRows(){
      try{
        isLoading = true;
        const { data, error } = await supabase
          .from('tasks')                           // table must be exactly 'tasks'
          .select('*')                             // columns: id,title,start_date,end_date,progress,notes
          .order('start_date',{ascending:true});
        isLoading = false;
        if(error){ console.error(error); showError(error.message, 'Check Supabase URL/key, RLS policy, and table/columns.'); allRows=[]; return; }
        allRows = data || [];
        if(!allRows.length){
          showError('No rows found in table "tasks".', 'Add some rows or pick another month.');
        } else {
          clearStatus();
        }
      }catch(e){
        isLoading = false;
        console.error(e);
        showError(String(e));
        allRows=[];
      }
    }

    function buildMonthPickerFromData(){
      buildingPicker = true;
      const months = new Set(allRows.map(r => keyFromDate(new Date(r.start_date))));
      const list = months.size ? Array.from(months) : [state.monthKey];
      list.sort(); // ascending
      monthSelect.innerHTML='';
      for(const key of list){
        const [y,m]=key.split('-').map(Number);
        const d = new Date(y, m-1, 1);
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = d.toLocaleString(undefined,{month:'long',year:'numeric'});
        monthSelect.appendChild(opt);
      }
      // Choose the most recent month with data if current has none
      if(months.size && !months.has(state.monthKey)){
        state.monthKey = list[list.length-1];
      }
      monthSelect.value = state.monthKey;
      buildingPicker = false;
    }

    async function renderForMonth(monthKey){
      const el = document.getElementById('gantt');
      const { start, end } = monthRangeFromKey(monthKey);
      const rows = allRows.filter(t => new Date(t.end_date||t.start_date)>=start && new Date(t.start_date)<=end);
      if(!rows.length){
        el.innerHTML = '<div style="text-align:center;color:#777;padding:18px">No tasks in this month.</div>';
        return;
      }

      const tasks = rows.map(r=>({
        id:String(r.id),
        name:r.title,
        start:toYMD(r.start_date),
        end:toYMD(r.end_date||r.start_date),
        progress:Number(r.progress||0),
        notes:r.notes||''
      }));
      tasksById = Object.fromEntries(tasks.map(t=>[t.id,t]));

      // Fit chart to container width (avoid inner slider)
      const w = Math.max(640, el.clientWidth - 24);
      const min = new Date(Math.min(...tasks.map(t=>new Date(t.start))));
      const max = new Date(Math.max(...tasks.map(t=>new Date(t.end))));
      const days = daysBetween(min,max);
      const column_width = Math.min(48, Math.max(22, Math.floor(w/days)));

      el.innerHTML='';
      gantt = new Gantt('#gantt', tasks, {
        view_mode: state.view,
        date_format: 'YYYY-MM-DD',
        bar_height: 28,
        padding: 28,
        column_width
      });

      applyColors();                 // now
      setTimeout(applyColors, 80);   // after layout settles
      setTimeout(applyColors, 180);  // belt & braces
      attachTooltip();
    }

    // ── Colours (forced to match legend) ───────────────────────────────────────
    function applyColors(){
      document.querySelectorAll('#gantt .bar-wrapper').forEach(w=>{
        const t = tasksById[w.getAttribute('data-id')]; if(!t) return;
        const base = w.querySelector('.bar');
        const prog = w.querySelector('.bar-progress');
        if(!base || !prog) return;
        const p = Math.max(0, Math.min(100, Number(t.progress||0)));
        const setFill = (node, color) => {
          node.style.fill = color; node.setAttribute('fill', color);
          node.style.stroke='none'; node.setAttribute('stroke','none');
        };
        if(p === 0){ setFill(base, css('--pending')); setFill(prog, 'rgba(0,0,0,0)'); }
        else if(p >= 100){ setFill(base, css('--done-base')); setFill(prog, css('--done')); }
        else { setFill(base, css('--doing')); setFill(prog, beigeRamp(p)); }
      });
    }
    function beigeRamp(p){ const h=38, s=70, lStart=90, lEnd=55; const l = lStart + (lEnd - lStart) * (p / 100); return `hsl(${h}, ${s}%, ${l}%)`; }

    // ── Tooltip ────────────────────────────────────────────────────────────────
    function attachTooltip(){
      const tip = document.getElementById('tip');
      document.querySelectorAll('#gantt .bar-wrapper').forEach(w=>{
        w.onmouseenter = () => {
          const t = tasksById[w.getAttribute('data-id')]; if(!t) return;
          tip.innerHTML = `<strong>${escapeHtml(t.name)}</strong><br>${t.start} → ${t.end}<br>${t.progress}%${t.notes?`<br>${escapeHtml(t.notes)}`:''}`;
          tip.style.display='block';
        };
        w.onmousemove = e => { tip.style.left=(e.pageX+12)+'px'; tip.style.top=(e.pageY-24)+'px'; };
        w.onmouseleave = () => { tip.style.display='none'; };
      });
    }

    // ── Utils ─────────────────────────────────────────────────────────────────
    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  </script>
</body>
</html>
