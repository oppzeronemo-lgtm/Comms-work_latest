<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>UDP Programme Comms Dashboard</title>

<!-- Supabase (UMD) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --pending:#FFD8A8;   /* Pending (0%) */
    --doing:#EDE8D0;     /* In progress base (ash/beige) */
    --done:#008000;      /* Completed overlay */
    --done-base:#E8F5EA; /* Completed base */
    --ink:#202124; --muted:#6b7280; --border:#e5e7eb; --card:#fafafa;
    --danger:#b42318; --danger-bg:#fee4e2;
  }

  html,body{height:100%}
  body{margin:0;background:#fff;color:var(--ink);font:15px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}

  .wrap{height:100%;display:flex;flex-direction:column;gap:12px;padding:16px;box-sizing:border-box}
  .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  .brand{font-weight:700;font-size:18px}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .controls .field{display:flex;align-items:center;gap:6px}
  .controls input[type="month"], .controls input[type="date"], .controls select{
    padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff
  }
  .controls button{padding:8px 12px;border:1px solid var(--border);background:#fff;border-radius:10px;cursor:pointer}
  .controls button.active{background:#111;color:#fff;border-color:#111}
  .range-title{color:#111;font-weight:700;min-width:220px}

  .card{flex:1;display:flex;flex-direction:column;min-height:0;background:var(--card);
        border:1px solid var(--border);border-radius:14px;padding:12px}

  /* Timeline layout */
  .timeline{display:grid;grid-template-rows:auto 1fr;gap:8px;flex:1;min-height:540px}

  .head{display:grid;gap:2px}
  .head-cell{background:#fff;border:1px solid var(--border);border-radius:8px;
             font-size:11px;color:#6b7280;text-align:center;padding:4px 0}
  .head-cell.big{font-weight:700;color:#111}

  .grid{display:grid;gap:10px;align-content:start}
  .task-label{align-self:center;font-size:13px;font-weight:600;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:8px}
  .task-bar-wrap{position:relative;height:46px;display:flex;align-items:center}

  .bar{
    position:absolute;height:34px;border-radius:10px;
    background:var(--doing); /* default */
    border:1px solid rgba(0,0,0,.06); box-shadow:0 2px 10px rgba(0,0,0,.05);
    overflow:hidden; left:0; width:0;
  }
  .bar.pending{background:var(--pending)}
  .bar.done{background:var(--done-base)}
  .bar .prog{
    position:absolute;left:0;top:0;height:100%;width:0;border-radius:10px 0 0 10px;
    background:transparent; /* set in JS */
  }

  .legend{display:flex;gap:18px;align-items:center;color:var(--muted);font-size:13px;margin-top:12px}
  .sw{width:12px;height:12px;border-radius:3px;margin-right:6px;display:inline-block;border:1px solid #d1d5db}
  .sw.pending{background:var(--pending)}
  .sw.doing{background:var(--doing)}
  .sw.done{background:var(--done)}

  .tip{position:fixed;transform:translate(-50%,-110%);background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;
       box-shadow:0 10px 24px rgba(0,0,0,.10);font-size:13px;display:none;pointer-events:none;z-index:1000;max-width:340px}

  .banner{border:1px solid var(--border);background:#fff;border-radius:10px;padding:14px;margin:10px 0;color:#111}
  .banner.error{border-color:var(--danger); background:var(--danger-bg); color:var(--danger)}
  .spinner{display:flex;align-items:center;gap:10px;color:var(--muted);padding:10px}
  .spinner:before{content:'';width:16px;height:16px;border-radius:50%;border:3px solid #ddd;border-top-color:#999;display:inline-block;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">UDP Programme Comms Dashboard</div>
      <div class="controls">
        <span class="range-title" id="rangeTitle">—</span>

        <div class="field">
          <label for="monthInput">Month</label>
          <input id="monthInput" type="month" />
        </div>

        <div class="field" id="weekField" style="display:none">
          <label for="weekSelect">Week</label>
          <select id="weekSelect"></select>
        </div>

        <div class="field" id="dayField" style="display:none">
          <label for="dayInput">Day</label>
          <input id="dayInput" type="date" />
        </div>

        <button id="viewMonth">Month</button>
        <button id="viewWeek">Week</button>
        <button id="viewDay">Day</button>
        <button id="prevBtn">◀</button>
        <button id="nextBtn">▶</button>
        <button id="todayBtn">Today</button>
        <button id="refreshBtn">Refresh</button>
      </div>
    </div>

    <div class="card">
      <div id="statusArea" class="spinner">Loading tasks…</div>

      <div class="timeline" id="timeline" style="display:none">
        <div class="head" id="head"></div>
        <div class="grid" id="grid"></div>
      </div>

      <div class="legend">
        <span><span class="sw pending"></span>Pending (0%)</span>
        <span><span class="sw doing"></span>In progress</span>
        <span><span class="sw done"></span>Completed (100%)</span>
      </div>
    </div>
  </div>

  <div id="tip" class="tip"></div>

<script>
  // ── Supabase ────────────────────────────────────────────────────────────────
  const SUPABASE_URL = "https://wjfgntocqjtwaqamlbgc.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqZmdudG9jcWp0d2FxYW1sYmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjQzODIsImV4cCI6MjA3MDk0MDM4Mn0.IRwC5-0cv2rkaZbzR1Ovxnt6dl0m1IwJgcLl2I67YzQ";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ── State ───────────────────────────────────────────────────────────────────
  const state = {
    view:'Month',              // 'Month' | 'Week' | 'Day'
    monthKey: keyFromDate(new Date()),
    weekIndex: 0,              // 0-based within chosen month
    dayDate: new Date()        // date for Day view
  };
  let allRows = [], tasks = [];
  let monthStart, monthEnd, daysInMonth, weeks=[];

  // ── Boot ────────────────────────────────────────────────────────────────────
  init();
  async function init(){
    bindControls();
    initPickers();
    markActiveView();
    showSpinner();
    await loadAllRows();
    await renderAll();
  }

  // ── Controls / Pickers ──────────────────────────────────────────────────────
  function bindControls(){
    viewMonth.onclick = ()=>{ state.view='Month'; markActiveView(); renderAll(); };
    viewWeek.onclick  = ()=>{ state.view='Week';  markActiveView(); renderAll(); };
    viewDay.onclick   = ()=>{ state.view='Day';   markActiveView(); renderAll(); };
    prevBtn.onclick   = ()=> nav(-1);
    nextBtn.onclick   = ()=> nav(1);
    todayBtn.onclick  = ()=> goToday();
    refreshBtn.onclick= async ()=>{ showSpinner('Refreshing…'); await loadAllRows(); await renderAll(); };

    monthInput.addEventListener('change', ()=>{
      state.monthKey = monthInput.value;
      // reset week/day inside that month
      const [yy,mm] = state.monthKey.split('-').map(Number);
      state.dayDate = new Date(yy, mm-1, 1);
      state.weekIndex = 0;
      renderAll();
    });
    weekSelect.addEventListener('change', ()=>{
      state.weekIndex = Number(weekSelect.value)||0;
      state.view = 'Week';
      markActiveView();
      renderAll();
    });
    dayInput.addEventListener('change', ()=>{
      const d = new Date(dayInput.value);
      if(!isNaN(d)) { state.dayDate = d; state.view='Day'; markActiveView(); renderAll(); }
    });
  }

  function initPickers(){
    // Month picker default = current state
    monthInput.value = state.monthKey;
    // Day picker default = today
    dayInput.value = toInputDate(state.dayDate);
  }

  function markActiveView(){
    [viewMonth, viewWeek, viewDay].forEach(b=>b.classList.remove('active'));
    if(state.view==='Month') viewMonth.classList.add('active');
    if(state.view==='Week')  viewWeek.classList.add('active');
    if(state.view==='Day')   viewDay.classList.add('active');

    // show/hide contextual pickers
    weekField.style.display = (state.view==='Week') ? 'flex' : 'none';
    dayField.style.display  = (state.view==='Day')  ? 'flex' : 'none';
  }

  function nav(dir){
    if(state.view==='Month'){
      shiftMonth(dir);
    } else if(state.view==='Week'){
      clampWeekIndex();
      state.weekIndex += dir;
      if(state.weekIndex < 0){
        shiftMonth(-1);
        weeks = getWeeksInMonth(monthStart);
        state.weekIndex = weeks.length - 1;
      } else if(state.weekIndex >= weeks.length){
        shiftMonth(1);
        weeks = getWeeksInMonth(monthStart);
        state.weekIndex = 0;
      }
    } else { // Day
      state.dayDate = addDays(state.dayDate, dir);
      if(state.dayDate < monthStart) shiftMonth(-1);
      if(state.dayDate > monthEnd)   shiftMonth(1);
      dayInput.value = toInputDate(state.dayDate);
    }
    renderAll();
  }
  function goToday(){
    const now = new Date();
    state.monthKey = keyFromDate(now);
    state.dayDate = new Date(now);
    state.weekIndex = 0;
    monthInput.value = state.monthKey;
    dayInput.value = toInputDate(state.dayDate);
    renderAll();
  }
  function shiftMonth(delta){
    const [y,m] = state.monthKey.split('-').map(Number);
    const d = new Date(y, m-1 + delta, 1);
    state.monthKey = keyFromDate(d);
    monthInput.value = state.monthKey;
    state.dayDate = new Date(d);
    state.weekIndex = 0;
  }

  // ── Data ────────────────────────────────────────────────────────────────────
  async function loadAllRows(){
    try{
      const { data, error } = await supabase
        .from('tasks')
        .select('*')
        .order('start_date',{ascending:true});
      if(error){ console.error(error); showError(error.message, 'Check URL, anon key, RLS policy, and table/columns.'); allRows=[]; return; }
      allRows = data || [];
      if(!allRows.length){ showError('No rows found in table "tasks".', 'Add some rows to table "tasks".'); }
      else { clearStatus(); }
    }catch(e){ console.error(e); showError(String(e)); allRows=[]; }
  }

  // ── Render orchestration ────────────────────────────────────────────────────
  async function renderAll(){
    setupMonthBounds();
    buildWeeksDropdown();

    const range = (state.view==='Day')  ? dayBounds(state.dayDate)
                 : (state.view==='Week') ? weeks[state.weekIndex]
                 : {start:monthStart, end:monthEnd};

    tasks = filterTasksForRange(range);
    buildHead(range);
    buildGrid(range);

    document.getElementById('timeline').style.display='grid';
    updateRangeTitle(range);
  }

  function setupMonthBounds(){
    const [y,m] = state.monthKey.split('-').map(Number);
    monthStart = new Date(y, m-1, 1);
    monthEnd   = new Date(y, m, 0, 23, 59, 59, 999);
    daysInMonth= monthEnd.getDate();
    weeks = getWeeksInMonth(monthStart);
    clampWeekIndex();
    // keep day inside visible month
    if(state.dayDate < monthStart) state.dayDate = new Date(monthStart);
    if(state.dayDate > monthEnd)   state.dayDate = new Date(monthEnd);
  }

  function buildWeeksDropdown(){
    weekSelect.innerHTML = '';
    weeks.forEach((w, i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `Week ${i+1} (${fmtMMM(dStr(w.start))}–${fmtMMM(dStr(w.end))})`;
      weekSelect.appendChild(opt);
    });
    weekSelect.value = state.weekIndex;
  }

  // ── Filtering & mapping ─────────────────────────────────────────────────────
  function filterTasksForRange(range){
    const rows = allRows.filter(t => new Date(t.end_date||t.start_date) >= range.start &&
                                     new Date(t.start_date) <= range.end);
    return rows.map(r=>({
      id:String(r.id),
      name:r.title,
      start:new Date(r.start_date),
      end:  new Date(r.end_date || r.start_date),
      progress: clamp(Number(r.progress||0),0,100),
      notes:r.notes||''
    }));
  }

  // ── Header builders ─────────────────────────────────────────────────────────
  function buildHead(range){
    const head = document.getElementById('head');
    head.innerHTML = '';
    const labelCol = '260px';

    if(state.view==='Month'){
      head.style.gridTemplateColumns = `${labelCol} repeat(${daysInMonth}, 1fr)`;
      const big = document.createElement('div');
      big.className = 'head-cell big';
      big.style.textAlign='left';
      big.textContent = monthStart.toLocaleString(undefined,{month:'long',year:'numeric'});
      head.appendChild(big);
      for(let d=1; d<=daysInMonth; d++){
        const date = new Date(monthStart.getFullYear(), monthStart.getMonth(), d);
        const cel = document.createElement('div');
        cel.className='head-cell';
        cel.textContent = `${date.toLocaleDateString(undefined,{weekday:'short'})} ${d}`;
        head.appendChild(cel);
      }
    } else if(state.view==='Week'){
      head.style.gridTemplateColumns = `${labelCol} repeat(7, 1fr)`;
      const big = document.createElement('div');
      big.className='head-cell big';
      big.style.textAlign='left';
      big.textContent = `Week ${state.weekIndex+1} • ${fmtMMM(dStr(range.start))} – ${fmtMMM(dStr(range.end))}`;
      head.appendChild(big);
      for(let i=0;i<7;i++){
        const date = addDays(range.start, i);
        const cel = document.createElement('div');
        cel.className='head-cell';
        cel.textContent = `${date.toLocaleDateString(undefined,{weekday:'short'})} ${date.getDate()}`;
        head.appendChild(cel);
      }
    } else {
      head.style.gridTemplateColumns = `${labelCol} repeat(24, 1fr)`;
      const big = document.createElement('div');
      big.className='head-cell big';
      big.style.textAlign='left';
      big.textContent = state.dayDate.toLocaleDateString(undefined,{weekday:'long', month:'long', day:'numeric', year:'numeric'});
      head.appendChild(big);
      for(let h=0; h<24; h++){
        const cel = document.createElement('div');
        cel.className='head-cell';
        cel.textContent = `${String(h).padStart(2,'0')}:00`;
        head.appendChild(cel);
      }
    }
  }

  // ── Grid / Bars ─────────────────────────────────────────────────────────────
  function buildGrid(range){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const labelCol = '260px';
    if(state.view==='Month'){
      grid.style.gridTemplateColumns = `${labelCol} repeat(${daysInMonth}, 1fr)`;
    } else if(state.view==='Week'){
      grid.style.gridTemplateColumns = `${labelCol} repeat(7, 1fr)`;
    } else {
      grid.style.gridTemplateColumns = `${labelCol} repeat(24, 1fr)`;
    }

    // rows
    for(const t of tasks){
      const label = document.createElement('div');
      label.className = 'task-label';
      label.textContent = t.name;
      grid.appendChild(label);

      const wrap = document.createElement('div');
      wrap.className = 'task-bar-wrap';
      wrap.style.gridColumn = `2 / -1`; // span all timeline columns

      // intersection with the visible range
      const a = maxDate(range.start, t.start);
      const b = minDate(range.end,   t.end);
      if(b < a){ grid.appendChild(wrap); continue; }

      const totalUnits = (state.view==='Day') ? 24 : (state.view==='Week') ? 7 : daysInMonth;

      let leftPct = 0, widthPct = 0;

      if(state.view==='Day'){
        // hours within the day (inclusive)
        const sHour = isSameDay(a, state.dayDate) ? a.getHours() : 0;
        const eHour = isSameDay(b, state.dayDate) ? b.getHours() : 23;
        leftPct  = (sHour / 24) * 100;
        widthPct = ((eHour - sHour + 1) / 24) * 100;
      } else {
        const unitStart = diffDays(range.start, a);
        const unitEnd   = diffDays(range.start, b);
        const spanUnits = Math.max(1, unitEnd - unitStart + 1);
        leftPct  = (unitStart / totalUnits) * 100;
        widthPct = (spanUnits / totalUnits) * 100;
      }

      // ensure visible even for 1 unit
      widthPct = Math.max(widthPct, (1/totalUnits)*100);

      const bar  = document.createElement('div');
      bar.className = 'bar';
      bar.style.left = leftPct + '%';
      bar.style.width = widthPct + '%';

      if(t.progress === 0){ bar.classList.add('pending'); }
      else if(t.progress >= 100){ bar.classList.add('done'); }

      const prog = document.createElement('div');
      prog.className = 'prog';
      if(t.progress === 0){
        prog.style.width = '0%';
      } else if(t.progress >= 100){
        prog.style.width = '100%';
        prog.style.background = 'var(--done)';
      } else {
        prog.style.width = `${t.progress}%`;
        prog.style.background = beigeRamp(t.progress);
      }

      // tooltip
      bar.addEventListener('mouseenter', e => showTip(e, t));
      bar.addEventListener('mousemove',  e => moveTip(e));
      bar.addEventListener('mouseleave', () => hideTip());
      bar.addEventListener('click',      e => { const tip=document.getElementById('tip'); if(tip.style.display==='block'){hideTip();} else {showTip(e,t);} });

      bar.appendChild(prog);
      wrap.appendChild(bar);
      grid.appendChild(wrap);
    }
  }

  // ── Range title ─────────────────────────────────────────────────────────────
  function updateRangeTitle(range){
    const el = document.getElementById('rangeTitle');
    if(state.view==='Month'){
      el.textContent = monthStart.toLocaleString(undefined,{month:'long',year:'numeric'});
    } else if(state.view==='Week'){
      el.textContent = `${monthStart.toLocaleString(undefined,{month:'long',year:'numeric'})} — Week ${state.weekIndex+1} (${fmtMMM(dStr(range.start))}–${fmtMMM(dStr(range.end))})`;
    } else {
      el.textContent = state.dayDate.toLocaleDateString(undefined,{month:'short', day:'numeric', year:'numeric'});
    }
  }

  // ── Helpers ─────────────────────────────────────────────────────────────────
  function keyFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
  function maxDate(a,b){ return (a>b)?a:b; } function minDate(a,b){ return (a<b)?a:b; }
  function stripTime(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function diffDays(a,b){ return Math.floor((stripTime(b) - stripTime(a)) / 86400000); }
  function dStr(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
  function fmtMMM(d){ return d.toLocaleDateString(undefined,{month:'short', day:'numeric'}); }
  function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function dayBounds(d){ const s = new Date(d.getFullYear(), d.getMonth(), d.getDate()); const e = new Date(s); e.setHours(23,59,59,999); return {start:s, end:e}; }
  function toInputDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  // Weeks start on Monday and cover the whole month.
  function getWeeksInMonth(firstOfMonth){
    const out = [];
    const year = firstOfMonth.getFullYear();
    const month= firstOfMonth.getMonth();
    let cursor = new Date(year, month, 1);
    const dow = (cursor.getDay()+6)%7; // Sun=0 -> 6; Mon=1 -> 0
    cursor.setDate(cursor.getDate() - dow); // back to Monday

    const monthEnd = new Date(year, month+1, 0, 23, 59, 59, 999);
    while(cursor <= monthEnd || out.length===0){
      const start = new Date(cursor);
      const end   = new Date(cursor); end.setDate(end.getDate()+6);
      const range = {
        start: new Date(Math.max(start, new Date(year,month,1))),
        end:   new Date(Math.min(end,   monthEnd))
      };
      out.push(range);
      cursor.setDate(cursor.getDate()+7);
      if(out.length>6) break; // safety
    }
    return out;
  }

  // Progressive warm beige ramp (1–99%)
  function beigeRamp(p){
    const h=38, s=70, lStart=90, lEnd=55;
    const l = lStart + (lEnd - lStart) * (p/100);
    return `hsl(${h}, ${s}%, ${l}%)`;
  }

  // Tooltip
  function showTip(e,t){
    const tip = document.getElementById('tip');
    tip.innerHTML = `<strong>${escapeHtml(t.name)}</strong><br>${fmtYMD(t.start)} → ${fmtYMD(t.end)}<br>${t.progress}%${t.notes?`<br>${escapeHtml(t.notes)}`:''}`;
    tip.style.display='block';
    moveTip(e);
  }
  function moveTip(e){
    const tip = document.getElementById('tip');
    tip.style.left = (e.clientX) + 'px';
    tip.style.top  = (e.clientY - 10) + 'px';
  }
  function hideTip(){ document.getElementById('tip').style.display='none'; }
  function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  function fmtYMD(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  // ── Status helpers ──────────────────────────────────────────────────────────
  function showSpinner(msg='Loading tasks…'){
    const s = document.getElementById('statusArea');
    s.className = 'spinner'; s.textContent = msg;
  }
  function showError(message, hint=''){
    const el = document.getElementById('statusArea');
    el.className = 'banner error';
    el.innerHTML = `<strong>Error:</strong> ${escapeHtml(message)}${hint?`<br><small>${escapeHtml(hint)}</small>`:''}`;
    document.getElementById('timeline').style.display = 'none';
  }
  function clearStatus(){ const el=document.getElementById('statusArea'); el.className=''; el.innerHTML=''; }
</script>
</body>
</html>
