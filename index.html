<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UDP Programme Comms Dashboard</title>

  <!-- Frappe Gantt (browser UMD build) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.5.0/dist/frappe-gantt.css" />
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.5.0/dist/frappe-gantt.min.js"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --headerH:64px;
      --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      /* progress palette requested: ash, beige, red */
      --ash:#cbd5e1;      /* base / not started */
      --beige:#f3e8d7;    /* progress */
      --red:#ef4444;      /* done */
      --ok:#22c55e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#fff;color:var(--ink);font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial}

    .app{min-height:100vh;display:flex;flex-direction:column}
    header{
      height:var(--headerH);display:flex;align-items:center;justify-content:space-between;
      gap:16px;padding:0 20px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:5
    }
    .brand{display:flex;gap:10px;align-items:center}
    .title{font-weight:700}
    .subtitle{color:var(--muted);font-size:12px;margin-top:2px}
    .live{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 6px rgba(34,197,94,.15);animation:pulse 1.8s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}70%{box-shadow:0 0 0 14px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .controls>*{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 12px}
    select,button{font:inherit;cursor:pointer}

    main{flex:1;display:flex;flex-direction:column}
    .canvas{
      flex:1;display:flex;flex-direction:column;gap:10px;
      padding:14px 16px 16px 16px;height:calc(100vh - var(--headerH));
    }
    #gantt{
      flex:1;min-height:60vh;border:1px solid var(--line);border-radius:12px;overflow:auto;background:#fff
    }

    /* legend */
    .legend{display:flex;gap:18px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .legend .label{font-weight:600;color:var(--ink)}
    .sw{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:6px;border:1px solid var(--line)}

    .hint{color:var(--muted);font-size:12px}

    /* Light theme for Gantt and stronger labels */
    .gantt .grid-row{fill:#fff}
    .gantt .grid-row:nth-child(even){fill:#f8fafc}
    .gantt .grid-header rect{fill:#fff}
    .gantt .lower-text,.gantt .upper-text,.gantt .bar-label,.gantt .bar-text{fill:#0f172a;font-weight:600}

    /* bars: ash base; beige progress; red when 100% */
    .gantt .bar{fill:var(--ash);opacity:1}
    .gantt .bar-progress{fill:var(--beige);transition:width .6s cubic-bezier(.22,.61,.36,1)}
    /* separator line where progress ends */
    .progress-edge{stroke:#b4a89a;stroke-width:1;shape-rendering:crispEdges}

    /* transparent hit area to capture hover anywhere */
    .hover-hit{fill:transparent;pointer-events:all}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="live" title="Realtime"></div>
        <div>
          <div class="title">UDP Programme Comms Dashboard</div>
          <div class="subtitle">Comms Focal: Abu Nayeem Md Shakib</div>
        </div>
      </div>
      <div class="controls">
        <select id="monthSelect" title="Pick month"></select>
        <button id="viewDay">Day</button>
        <button id="viewWeek">Week</button>
        <button id="viewMonth">Month</button>
        <button id="refreshBtn" title="Force refresh">Refresh</button>
      </div>
    </header>

    <main>
      <section class="canvas">
        <div id="gantt"></div>

        <div class="legend">
          <span class="label">Task progress</span>
          <span><span class="sw" style="background:var(--ash)"></span>Not started</span>
          <span><span class="sw" style="background:var(--beige)"></span>In progress</span>
          <span><span class="sw" style="background:var(--red)"></span>Done</span>
        </div>
        <div class="hint">Times show in your device timezone. For Dhaka, set Asia/Dhaka.</div>
      </section>
    </main>
  </div>

  <script>
    // Supabase credentials (yours)
    const SUPABASE_URL = "https://wjfgntocqjtwaqamlbgc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqZmdudG9jcWp0d2FxYW1sYmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjQzODIsImV4cCI6MjA3MDk0MDM4Mn0.IRwC5-0cv2rkaZbzR1Ovxnt6dl0m1IwJgcLl2I67YzQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = { view: 'Week', monthKey: keyFromDate(new Date()) };
    const monthSelect = document.getElementById('monthSelect');
    const btnDay   = document.getElementById('viewDay');
    const btnWeek  = document.getElementById('viewWeek');
    const btnMonth = document.getElementById('viewMonth');
    const refreshBtn = document.getElementById('refreshBtn');
    const ganttEl = document.getElementById('gantt');
    let gantt, lastTasks = [];

    init();

    async function init(){
      buildMonthPicker();
      await render();
      subscribeRealtime();
      btnDay.onclick   = () => setView('Day');
      btnWeek.onclick  = () => setView('Week');
      btnMonth.onclick = () => setView('Month');
      refreshBtn.onclick = () => render();
      monthSelect.onchange = () => { state.monthKey = monthSelect.value; render(); };
      window.addEventListener('resize', () => setTimeout(() => enhanceBars(lastTasks), 60));
    }

    function setView(v){ state.view = v; if(gantt) gantt.change_view_mode(v); }

    function buildMonthPicker(){
      monthSelect.innerHTML = '';
      const base = new Date(); base.setDate(1);
      for(let offset=-2; offset<=9; offset++){
        const d = new Date(base); d.setMonth(d.getMonth()+offset);
        const opt = document.createElement('option');
        const key = keyFromDate(d);
        opt.value = key;
        opt.textContent = d.toLocaleString(undefined, { month:'long', year:'numeric' });
        if(key === state.monthKey) opt.selected = true;
        monthSelect.appendChild(opt);
      }
    }

    function keyFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function monthRangeFromKey(key){
      const [y,m] = key.split('-').map(Number);
      const start = new Date(y, m-1, 1);
      const end = new Date(y, m, 0, 23, 59, 59, 999);
      return { start, end };
    }

    async function fetchTasks(){
      const { data, error } = await supabase.from('tasks').select('*').order('start_date', { ascending: true });
      if(error){ console.error(error); return []; }
      const { start, end } = monthRangeFromKey(state.monthKey);
      return (data || []).filter(t => {
        const s = new Date(t.start_date); const e = new Date(t.end_date || t.start_date);
        return e >= start && s <= end;
      });
    }

    async function render(){
      const rows = await fetchTasks();
      const tasks = rows.map(r => ({
        id: r.id,
        name: r.title,
        start: fmt(r.start_date),
        end: fmt(r.end_date || r.start_date),
        progress: Number(r.progress || 0),
        dependencies: (r.dependencies || '').trim(),
        custom_class: statusClass(Number(r.progress || 0)),
        notes: (r.notes ?? r.description ?? '').trim()
      }));
      lastTasks = tasks;

      ganttEl.innerHTML = '';
      gantt = new Gantt('#gantt', tasks, {
        view_mode: state.view,
        date_format: 'YYYY-MM-DD',
        language: 'en',
        bar_height: 26,
        padding: 22,
        custom_popup_html: task => `
          <div style="background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px 12px;max-width:260px;box-shadow:0 8px 20px rgba(2,6,23,.08)">
            <div style="font-weight:700">${escapeHtml(task.name)}</div>
            <div style="color:#64748b;font-size:12px;margin-top:2px">${task._start.format('ll')} → ${task._end.format('ll')} · ${task.progress}%</div>
            <div style="margin-top:6px;font-size:12px;color:#0f172a">${escapeHtml(task.notes || 'No description')}</div>
          </div>`
      });

      enhanceBars(tasks); // color, separator, tooltips, hover popup
    }

    function statusClass(p){ if(p>=100) return 'is-done'; if(p>0) return 'is-doing'; return 'is-todo'; }

    function subscribeRealtime(){
      supabase.channel('public:tasks')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, debounce(render, 200))
        .subscribe();
    }

    function enhanceBars(tasks){
      const map = Object.fromEntries(tasks.map(t => [String(t.id), t]));

      document.querySelectorAll('.gantt .bar-wrapper').forEach(wrap => {
        const id = wrap.getAttribute('data-id');
        const bar = wrap.querySelector('rect.bar');
        const prog = wrap.querySelector('rect.bar-progress');
        if(!bar) return;

        // base / progress colors
        bar.setAttribute('fill', getComputedStyle(document.documentElement).getPropertyValue('--ash').trim());

        if(prog){
          const barW  = parseFloat(bar.getAttribute('width')||'0');
          const progW = parseFloat(prog.getAttribute('width')||'0');
          const done = barW>0 && Math.abs(barW - progW) < 0.5;
          prog.setAttribute('fill', done
            ? getComputedStyle(document.documentElement).getPropertyValue('--red').trim()
            : getComputedStyle(document.documentElement).getPropertyValue('--beige').trim());

          // draw / update separator line at progress edge
          let edge = wrap.querySelector('line.progress-edge');
          if(!edge){
            edge = document.createElementNS('http://www.w3.org/2000/svg','line');
            edge.setAttribute('class','progress-edge');
            wrap.appendChild(edge);
          }
          const x = parseFloat(bar.getAttribute('x')||'0') + progW;
          const y = parseFloat(bar.getAttribute('y')||'0');
          const h = parseFloat(bar.getAttribute('height')||'0');
          edge.setAttribute('x1', x); edge.setAttribute('x2', x);
          edge.setAttribute('y1', y+1); edge.setAttribute('y2', y+h-1);
          edge.style.display = (progW>0 && !done) ? 'block' : 'none';
        }

        // stronger text label on the bar (Frappe adds it for us; we just ensure contrast via CSS above)

        // hover hit area covering whole bar + tooltip + popup
        let hit = wrap.querySelector('rect.hover-hit');
        if(!hit){
          hit = document.createElementNS('http://www.w3.org/2000/svg','rect');
          hit.setAttribute('class','hover-hit');
          wrap.appendChild(hit);
        }
        ['x','y','width','height','rx','ry'].forEach(a=>{
          const v = bar.getAttribute(a); if(v!=null) hit.setAttribute(a, v);
        });

        // tooltip text (title + notes)
        const t = map[id];
        const tip = t ? `${t.name}${t.notes ? ' — ' + t.notes : ''}` : '';
        let old = hit.querySelector('title'); if(old) old.remove();
        const title = document.createElementNS('http://www.w3.org/2000/svg','title');
        title.textContent = tip; hit.appendChild(title);

        hit.onmouseenter = () => {
          if(gantt && typeof gantt.show_popup === 'function') gantt.show_popup(t);
          else wrap.dispatchEvent(new MouseEvent('click', { bubbles:true }));
        };
        hit.onmouseleave = () => { if(gantt && typeof gantt.hide_popup === 'function') gantt.hide_popup(); };
      });
    }

    // utils
    function fmt(d){ const x=new Date(d), y=x.getFullYear(), m=String(x.getMonth()+1).padStart(2,'0'), dd=String(x.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }
    function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c])); }
  </script>
</body>
</html>
