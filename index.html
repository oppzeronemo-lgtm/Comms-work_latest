<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UDP Programme Comms Dashboard</title>

  <!-- Frappe Gantt (browser-ready UMD build) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.5.0/dist/frappe-gantt.css" />
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.5.0/dist/frappe-gantt.min.js"></script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #0b0c10;
      --card: #111318;
      --muted: #9aa4b2;
      --text: #e8eef7;
      --accent: #4f46e5;
      --ok: #22c55e;
      --warn: #f59e0b;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .live-dot{width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 0 6px rgba(34,197,94,.15);animation:pulse 1.8s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.5)}70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .controls>*{background:var(--card);color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px 12px}
    select,button{font:inherit}
    .hint{color:var(--muted);font-size:12px}
    #gantt{overflow:auto;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:16px}
    .legend{display:flex;gap:16px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px;margin-top:8px}
    .legend .sw{width:10px;height:10px;border-radius:3px;display:inline-block;margin-right:6px}
    .details-card{background:#0f1218;border:1px solid rgba(255,255,255,.1);padding:10px 12px;border-radius:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="live-dot" title="Realtime connected"></div>
        <div>
          <div style="font-weight:600">UDP Programme Comms Dashboard</div>
          <div class="hint">Comms Focal: Abu Nayeem Md Shakib</div>
        </div>
      </div>
      <div class="controls">
        <select id="monthSelect" title="Pick month"></select>
        <button id="viewDay">Day</button>
        <button id="viewWeek">Week</button>
        <button id="viewMonth">Month</button>
        <button id="refreshBtn" title="Force refresh">Refresh</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div id="gantt"></div>
      <div class="legend">
        <span><span class="sw" style="background:#4f46e5"></span>Task</span>
        <span><span class="sw" style="background:#22c55e"></span>Done</span>
        <span><span class="sw" style="background:#f59e0b"></span>In progress</span>
      </div>
      <div class="hint" style="margin-top:8px">Times show in your device timezone. For Dhaka, set Asia/Dhaka.</div>
    </div>
  </div>

  <script>
    // Supabase credentials (yours)
    const SUPABASE_URL = "https://wjfgntocqjtwaqamlbgc.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqZmdudG9jcWp0d2FxYW1sYmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjQzODIsImV4cCI6MjA3MDk0MDM4Mn0.IRwC5-0cv2rkaZbzR1Ovxnt6dl0m1IwJgcLl2I67YzQ";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = { view: 'Week', monthKey: keyFromDate(new Date()) };
    const monthSelect = document.getElementById('monthSelect');
    const btnDay = document.getElementById('viewDay');
    const btnWeek = document.getElementById('viewWeek');
    const btnMonth = document.getElementById('viewMonth');
    const refreshBtn = document.getElementById('refreshBtn');
    const ganttEl = document.getElementById('gantt');
    let gantt;

    init();

    async function init(){
      buildMonthPicker();
      await render();
      subscribeRealtime();
      hookControls();
    }

    function hookControls(){
      btnDay.onclick = () => setView('Day');
      btnWeek.onclick = () => setView('Week');
      btnMonth.onclick = () => setView('Month');
      refreshBtn.onclick = () => render();
      monthSelect.onchange = () => { state.monthKey = monthSelect.value; render(); };
    }

    function setView(v){ state.view = v; if(gantt) gantt.change_view_mode(v); }

    function buildMonthPicker(){
      monthSelect.innerHTML = '';
      const base = new Date(); base.setDate(1);
      for(let offset=-2; offset<=9; offset++){
        const d = new Date(base); d.setMonth(d.getMonth()+offset);
        const key = keyFromDate(d);
        const opt = document.createElement('option');
        opt.value = key;
        const label = d.toLocaleString(undefined, { month:'long', year:'numeric' });
        opt.textContent = label;
        if(key === state.monthKey) opt.selected = true;
        monthSelect.appendChild(opt);
      }
    }

    function keyFromDate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }

    function monthRangeFromKey(key){
      const [y,m] = key.split('-').map(Number);
      const start = new Date(y, m-1, 1);
      const end = new Date(y, m, 0, 23, 59, 59, 999);
      return { start, end };
    }

    async function fetchTasks(){
      const { data, error } = await supabase
        .from('tasks')
        .select('*')
        .order('start_date', { ascending: true });
      if(error){ console.error(error); return []; }
      const { start, end } = monthRangeFromKey(state.monthKey);
      return (data || []).filter(t => {
        const s = new Date(t.start_date);
        const e = new Date(t.end_date || t.start_date);
        return e >= start && s <= end; // overlaps month
      });
    }

    async function render(){
      const rows = await fetchTasks();
      const tasks = rows.map(r => ({
        id: r.id,
        name: r.title,
        start: formatDate(r.start_date),
        end: formatDate(r.end_date || r.start_date),
        progress: Number(r.progress || 0),
        dependencies: (r.dependencies || '').trim(),
        custom_class: statusClass(Number(r.progress || 0)),
        // read notes from 'notes' or fall back to 'description'
        notes: (r.notes ?? r.description ?? '').trim()
      }));

      ganttEl.innerHTML = '';
      if(!tasks.length){
        ganttEl.innerHTML = "<div class='hint' style='padding:10px'>No tasks found for this month.</div>";
        return;
      }

      // draw the gantt with a custom popup (on click)
      gantt = new Gantt('#gantt', tasks, {
        view_mode: state.view,
        date_format: 'YYYY-MM-DD',
        language: 'en',
        custom_popup_html: task => {
          return `
            <div class="details-card">
              <div style="font-weight:600">${escapeHtml(task.name)}</div>
              <div class="hint">${task._start.format('ll')} → ${task._end.format('ll')} · ${task.progress}%</div>
              <div style="margin-top:6px;font-size:12px;color:#cbd5e1">${escapeHtml(task.notes || 'No description')}</div>
            </div>`;
        }
      });

      // true hover tooltips: inject SVG <title> into each bar
      setSvgHoverTitles(tasks);

      // also fix tooltips after a tiny delay (in case the library redraws)
      setTimeout(() => setSvgHoverTitles(tasks), 150);
    }

    function statusClass(p){
      const done = p >= 100, doing = p > 0 && p < 100;
      return done ? 'is-done' : doing ? 'is-doing' : 'is-todo';
    }

    function subscribeRealtime(){
      supabase.channel('public:tasks')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'tasks' }, debounce(render, 300))
        .subscribe();
    }

    // --- helpers for hover + formatting ---
    function setSvgHoverTitles(tasks){
      const map = Object.fromEntries(tasks.map(t => [String(t.id), t]));
      document.querySelectorAll('.gantt .bar-wrapper').forEach(wrap => {
        const id = wrap.getAttribute('data-id');
        const rect = wrap.querySelector('.bar'); // SVG rect
        if(!rect) return;

        // remove existing <title> if any
        const oldTitle = rect.querySelector('title');
        if(oldTitle) oldTitle.remove();

        // build hover text: name + notes
        const t = map[id];
        const note = (t?.notes || '').trim();
        const hover = (t ? `${t.name}${note ? ' — ' + note : ''}` : (wrap.textContent || '').trim());

        // add SVG <title>
        const titleEl = document.createElementNS('http://www.w3.org/2000/svg','title');
        titleEl.textContent = hover;
        rect.appendChild(titleEl);
      });
    }

    function formatDate(d){
      const x = new Date(d);
      const yyyy = x.getFullYear();
      const mm = String(x.getMonth()+1).padStart(2, '0');
      const dd = String(x.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    function debounce(fn, wait){
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(this,args), wait); };
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[c]));
    }
  </script>

  <style>
    .gantt .bar.is-done{opacity:.8}
    .gantt .bar.is-doing{filter:saturate(1.2)}
    .gantt .bar.is-todo{opacity:.9}
  </style>
</body>
</html>
