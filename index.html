<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UDP Programme Comms Dashboard</title>

  <!-- Frappe Gantt -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.5.0/dist/frappe-gantt.css" />
  <script src="https://cdn.jsdelivr.net/npm/frappe-gantt@0.5.0/dist/frappe-gantt.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --ash:#e2e8f0; --beige:#f3e8d7; --red:#ef4444; --live:#22c55e;
    }
    html,body{height:100%;margin:0}
    body{font:14px system-ui, sans-serif;color:var(--ink);background:var(--bg);}

    .app{display:flex;flex-direction:column;height:100vh}

    header{display:flex;justify-content:space-between;align-items:center;
      padding:10px 20px;border-bottom:1px solid var(--line);background:#fff;}
    .brand{display:flex;gap:8px;align-items:center}
    .live{width:10px;height:10px;border-radius:50%;background:var(--live);
      box-shadow:0 0 0 6px rgba(34,197,94,.15);animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,.4)}70%{box-shadow:0 0 0 12px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}

    .controls{display:flex;gap:8px}
    .controls>*{padding:6px 12px;border:1px solid var(--line);border-radius:6px;background:#fff;cursor:pointer}

    main{flex:1;display:flex;flex-direction:column}
    #gantt{flex:1;overflow-x:auto;overflow-y:hidden; /* keep scrollbar bottom */
      border:1px solid var(--line);border-radius:8px;background:#fff}

    .legend{margin:8px 12px;display:flex;gap:16px;font-size:13px;color:var(--muted)}
    .legend span{display:flex;align-items:center;gap:5px}
    .sw{width:12px;height:12px;border-radius:3px;border:1px solid var(--line)}

    /* Gantt tweaks */
    .gantt .grid-row:nth-child(even){fill:#fafafa}
    .gantt .bar-label{fill:var(--ink);font-weight:600;font-size:12px}
    .gantt .bar{fill:var(--ash)}
    .gantt .bar-progress{fill:var(--beige);transition:width .6s}
    .progress-edge{stroke:#b4a89a;stroke-width:1}
    .hover-hit{fill:transparent;pointer-events:all}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="live"></div>
      <div>
        <div><b>UDP Programme Comms Dashboard</b></div>
        <div style="font-size:12px;color:var(--muted)">Comms Focal: Abu Nayeem Md Shakib</div>
      </div>
    </div>
    <div class="controls">
      <select id="monthSelect"></select>
      <button id="viewDay">Day</button>
      <button id="viewWeek">Week</button>
      <button id="viewMonth">Month</button>
      <button id="refreshBtn">Refresh</button>
    </div>
  </header>
  <main>
    <div id="gantt"></div>
    <div class="legend">
      <span><span class="sw" style="background:var(--ash)"></span>Not started</span>
      <span><span class="sw" style="background:var(--beige)"></span>In progress</span>
      <span><span class="sw" style="background:var(--red)"></span>Done</span>
    </div>
  </main>
</div>

<script>
const SUPABASE_URL="https://wjfgntocqjtwaqamlbgc.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqZmdudG9jcWp0d2FxYW1sYmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjQzODIsImV4cCI6MjA3MDk0MDM4Mn0.IRwC5-0cv2rkaZbzR1Ovxnt6dl0m1IwJgcLl2I67YzQ";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let gantt,lastTasks=[]; const state={view:"Week"};

init();
async function init(){
  await render();
  supabase.channel("public:tasks").on("postgres_changes",{event:"*",schema:"public",table:"tasks"},()=>render()).subscribe();
  document.getElementById("viewDay").onclick=()=>{state.view="Day";gantt.change_view_mode("Day")};
  document.getElementById("viewWeek").onclick=()=>{state.view="Week";gantt.change_view_mode("Week")};
  document.getElementById("viewMonth").onclick=()=>{state.view="Month";gantt.change_view_mode("Month")};
  document.getElementById("refreshBtn").onclick=()=>render();
}

async function render(){
  const {data,error}=await supabase.from("tasks").select("*").order("start_date");
  if(error){console.error(error);return}
  const tasks=(data||[]).map(r=>({
    id:r.id,name:r.title,start:fmt(r.start_date),end:fmt(r.end_date||r.start_date),
    progress:Number(r.progress||0),notes:r.notes||""
  }));
  lastTasks=tasks;
  document.getElementById("gantt").innerHTML="";
  gantt=new Gantt("#gantt",tasks,{view_mode:state.view,bar_height:24,padding:20,
    custom_popup_html:task=>`<div style="padding:8px 10px"><b>${task.name}</b><br>${task.progress}%<br>${task.notes}</div>`
  });
  enhance(tasks);
}

function enhance(tasks){
  const map=Object.fromEntries(tasks.map(t=>[t.id,t]));
  document.querySelectorAll(".bar-wrapper").forEach(w=>{
    const id=w.getAttribute("data-id"), t=map[id];
    const bar=w.querySelector("rect.bar"), prog=w.querySelector("rect.bar-progress");
    if(!bar) return;

    // base color
    bar.setAttribute("fill","var(--ash)");

    if(prog){
      if(t.progress>=100){
        bar.setAttribute("fill","var(--red)");
        prog.setAttribute("fill","var(--red)");
        prog.setAttribute("width",bar.getAttribute("width")); // full width
      }else if(t.progress>0){
        prog.setAttribute("fill","var(--beige)");
      }
      // separator line
      let edge=w.querySelector("line.progress-edge");
      if(!edge){edge=document.createElementNS("http://www.w3.org/2000/svg","line");edge.setAttribute("class","progress-edge");w.appendChild(edge);}
      const x=+bar.getAttribute("x")+ +prog.getAttribute("width"), y=+bar.getAttribute("y"), h=+bar.getAttribute("height");
      edge.setAttribute("x1",x);edge.setAttribute("x2",x);edge.setAttribute("y1",y+1);edge.setAttribute("y2",y+h-1);
      edge.style.display=(t.progress>0 && t.progress<100)?"block":"none";
    }

    // hover
    let hit=w.querySelector(".hover-hit"); if(!hit){hit=document.createElementNS("http://www.w3.org/2000/svg","rect");hit.setAttribute("class","hover-hit");w.appendChild(hit);}
    ["x","y","width","height"].forEach(a=>hit.setAttribute(a,bar.getAttribute(a)));
    let old=hit.querySelector("title");if(old)old.remove();
    let title=document.createElementNS("http://www.w3.org/2000/svg","title");title.textContent=t.name+" â€” "+t.notes;hit.appendChild(title);
  });
}
function fmt(d){const x=new Date(d);return x.toISOString().split("T")[0]}
</script>
</body>
</html>
